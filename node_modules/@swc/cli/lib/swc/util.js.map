{"version":3,"sources":["../../src/swc/util.ts"],"sourcesContent":["import * as swc from \"@swc/core\";\nimport slash from \"slash\";\nimport { mkdirSync, writeFileSync } from \"fs\";\nimport { dirname, relative } from \"path\";\n\n\nexport async function transform(\n  filename: string,\n  code: string,\n  opts: swc.Options,\n  sync: boolean,\n  outputPath: string | undefined\n): Promise<swc.Output> {\n  opts = {\n    filename,\n    ...opts,\n  };\n\n  if (outputPath) {\n    opts.outputPath = outputPath;\n  }\n\n  if (sync) {\n    return swc.transformSync(code, opts);\n  }\n\n  return swc.transform(code, opts);\n}\n\nexport async function compile(\n  filename: string,\n  opts: swc.Options,\n  sync: boolean,\n  outputPath: string | undefined\n): Promise<swc.Output | void> {\n  opts = {\n    ...opts\n  };\n  if (outputPath) {\n    opts.outputPath = outputPath;\n  }\n\n  try {\n    const result = sync\n      ? swc.transformFileSync(filename, opts)\n      : await swc.transformFile(filename, opts);\n\n    if (result.map) {\n      // TODO: fix this in core\n      // https://github.com/swc-project/swc/issues/1388\n      const sourceMap = JSON.parse(result.map);\n      if (opts.sourceFileName) {\n        sourceMap['sources'][0] = opts.sourceFileName;\n      }\n      if (opts.sourceRoot) {\n        sourceMap['sourceRoot'] = opts.sourceRoot;\n      }\n      result.map = JSON.stringify(sourceMap);\n    }\n    return result;\n  } catch (err) {\n    if (!err.message.includes(\"ignored by .swcrc\")) {\n      throw err;\n    }\n  }\n}\n\nexport function outputFile(\n  output: swc.Output,\n  filename: string,\n  sourceMaps: undefined | swc.Options['sourceMaps']\n) {\n  const destDir = dirname(filename);\n  mkdirSync(destDir, { recursive: true });\n\n  let code = output.code;\n  if (output.map && sourceMaps !== \"inline\") {\n    // we've requested for a sourcemap to be written to disk\n    const fileDirName = dirname(filename);\n    const mapLoc = filename + \".map\";\n    code += \"\\n//# sourceMappingURL=\" + slash(relative(fileDirName, mapLoc));\n    writeFileSync(mapLoc, output.map);\n  }\n\n  writeFileSync(filename, code);\n}\n\n\nexport function assertCompilationResult<T>(\n  result: Map<string, Error | T>,\n  quiet = false\n): asserts result is Map<string, T> {\n  let compiled = 0;\n  let copied = 0;\n  let failed = 0;\n  for (const value of result.values()) {\n    if (value instanceof Error) {\n      failed++;\n    } else if (value as unknown === 'copied') {\n      copied++;\n    } else if (value) {\n      compiled++;\n    }\n  }\n  if (!quiet && compiled + copied > 0) {\n    const copyResult = copied === 0 ? \" \" : ` (copied ${copied}) `;\n    console.info(\n      `Successfully compiled ${compiled} ${compiled !== 1 ? \"files\" : \"file\"}${copyResult}with swc.`\n    );\n  }\n\n  if (failed > 0) {\n    throw new Error(\n      `Failed to compile ${failed} ${failed !== 1 ? \"files\" : \"file\"} with swc.`\n    );\n  }\n}\n"],"names":[],"mappings":"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"}