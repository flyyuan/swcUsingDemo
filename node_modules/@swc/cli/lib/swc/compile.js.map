{"version":3,"sources":["../../src/swc/compile.ts"],"sourcesContent":["import slash from 'slash';\nimport { promises } from \"fs\";\nimport { dirname, relative } from \"path\";\nimport { transformFile, transformFileSync } from \"@swc/core\";\nimport type { Options, Output } from \"@swc/core\";\n\nconst {\n  mkdir,\n  stat,\n  writeFile\n} = promises;\n\nfunction withSourceMap(output: Output, options: Options, destFile: string, destDir: string) {\n  if (!output.map || options.sourceMaps === \"inline\") {\n    return {\n      sourceCode: output.code,\n    }\n  }\n  // TODO: remove once fixed in core https://github.com/swc-project/swc/issues/1388\n  const sourceMap = JSON.parse(output.map);\n  if (options.sourceFileName) {\n    sourceMap['sources'][0] = options.sourceFileName;\n  }\n  if (options.sourceRoot) {\n    sourceMap['sourceRoot'] = options.sourceRoot;\n  }\n  output.map = JSON.stringify(sourceMap);\n\n  const sourceMapPath = destFile + \".map\";\n  output.code += `\\n//# sourceMappingURL=${slash(relative(destDir, sourceMapPath))}`;\n\n  return {\n    sourceMap: output.map,\n    sourceMapPath,\n    sourceCode: output.code\n  }\n}\n\nexport async function outputResult(\n  output: Output,\n  sourceFile: string,\n  destFile: string,\n  options: Options\n) {\n  const destDir = dirname(destFile);\n\n  const {\n    sourceMap,\n    sourceMapPath,\n    sourceCode\n  } = withSourceMap(output, options, destFile, destDir);\n\n  await mkdir(destDir, { recursive: true });\n  const { mode } = await stat(sourceFile);\n\n  if (!sourceMapPath) {\n    await writeFile(destFile, sourceCode, { mode });\n  } else {\n    await Promise.all([\n      writeFile(destFile, sourceCode, { mode }),\n      writeFile(sourceMapPath, sourceMap, { mode })\n    ]);\n  }\n}\n\nexport async function compile(\n  filename: string,\n  opts: Options,\n  sync: boolean,\n  outputPath: string | undefined\n): Promise<Output | void> {\n  const options = { ...opts };\n  if (outputPath) {\n    options.outputPath = outputPath;\n  }\n\n  try {\n    const result = sync\n      ? transformFileSync(filename, options)\n      : await transformFile(filename, options);\n\n    return result;\n  } catch (err) {\n    if (!err.message.includes(\"ignored by .swcrc\")) {\n      throw err;\n    }\n  }\n}\n"],"names":[],"mappings":";;;;QAsCsB,YAAY,GAAZ,YAAY;QA2BZ,OAAO,GAAP,OAAO;AAjEX,GAAO,CAAP,MAAO;AACA,GAAI,CAAJ,GAAI;AACK,GAAM,CAAN,KAAM;AACS,GAAW,CAAX,KAAW;;;;;;AAG5D,KAAK,GACH,KAAK,GACL,IAAI,GACJ,SAAS,MARc,GAAI;SAWpB,aAAa,CAAC,MAAc,EAAE,OAAgB,EAAE,QAAgB,EAAE,OAAe,EAAE,CAAC;IAC3F,EAAE,GAAG,MAAM,CAAC,GAAG,IAAI,OAAO,CAAC,UAAU,MAAK,MAAQ,GAAE,CAAC;;YAEjD,UAAU,EAAE,MAAM,CAAC,IAAI;;IAE3B,CAAC;IACD,EAAiF,AAAjF,+EAAiF;IACjF,KAAK,CAAC,SAAS,GAAG,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,GAAG;IACvC,EAAE,EAAE,OAAO,CAAC,cAAc,EAAE,CAAC;QAC3B,SAAS,EAAC,OAAS,GAAE,CAAC,IAAI,OAAO,CAAC,cAAc;IAClD,CAAC;IACD,EAAE,EAAE,OAAO,CAAC,UAAU,EAAE,CAAC;QACvB,SAAS,EAAC,UAAY,KAAI,OAAO,CAAC,UAAU;IAC9C,CAAC;IACD,MAAM,CAAC,GAAG,GAAG,IAAI,CAAC,SAAS,CAAC,SAAS;IAErC,KAAK,CAAC,aAAa,GAAG,QAAQ,IAAG,IAAM;IACvC,MAAM,CAAC,IAAI,KAAK,uBAAuB,MA7BvB,MAAO,cAES,KAAM,WA2BkB,OAAO,EAAE,aAAa;;QAG5E,SAAS,EAAE,MAAM,CAAC,GAAG;QACrB,aAAa;QACb,UAAU,EAAE,MAAM,CAAC,IAAI;;AAE3B,CAAC;eAEqB,YAAY,CAChC,MAAc,EACd,UAAkB,EAClB,QAAgB,EAChB,OAAgB,EAChB,CAAC;IACD,KAAK,CAAC,OAAO,OA1CmB,KAAM,UA0Cd,QAAQ;IAEhC,KAAK,GACH,SAAS,GACT,aAAa,GACb,UAAU,MACR,aAAa,CAAC,MAAM,EAAE,OAAO,EAAE,QAAQ,EAAE,OAAO;UAE9C,KAAK,CAAC,OAAO;QAAI,SAAS,EAAE,IAAI;;IACtC,KAAK,GAAG,IAAI,YAAW,IAAI,CAAC,UAAU;IAEtC,EAAE,GAAG,aAAa,EAAE,CAAC;cACb,SAAS,CAAC,QAAQ,EAAE,UAAU;YAAI,IAAI;;IAC9C,CAAC,MAAM,CAAC;cACA,OAAO,CAAC,GAAG;YACf,SAAS,CAAC,QAAQ,EAAE,UAAU;gBAAI,IAAI;;YACtC,SAAS,CAAC,aAAa,EAAE,SAAS;gBAAI,IAAI;;;IAE9C,CAAC;AACH,CAAC;eAEqB,OAAO,CAC3B,QAAgB,EAChB,IAAa,EACb,IAAa,EACb,UAA8B,EACN,CAAC;IACzB,KAAK,CAAC,OAAO;WAAQ,IAAI;;IACzB,EAAE,EAAE,UAAU,EAAE,CAAC;QACf,OAAO,CAAC,UAAU,GAAG,UAAU;IACjC,CAAC;QAEG,CAAC;QACH,KAAK,CAAC,MAAM,GAAG,IAAI,OA1E0B,KAAW,oBA2ElC,QAAQ,EAAE,OAAO,cA3EM,KAAW,gBA4EhC,QAAQ,EAAE,OAAO;eAElC,MAAM;IACf,CAAC,QAAQ,GAAG,EAAE,CAAC;QACb,EAAE,GAAG,GAAG,CAAC,OAAO,CAAC,QAAQ,EAAC,iBAAmB,IAAG,CAAC;YAC/C,KAAK,CAAC,GAAG;QACX,CAAC;IACH,CAAC;AACH,CAAC"}